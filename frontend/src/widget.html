<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CommentKit Bridge</title>
    <!-- Content Security Policy for XSS protection -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline';
        style-src 'self' 'unsafe-inline';
        connect-src *;
        frame-ancestors *;
        img-src 'self' data:;
        form-action 'none';
        base-uri 'self';
    ">
    <!-- Prevent MIME sniffing -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
</head>

<body>
    <script>
        // This iframe acts as a bridge for cross-domain authentication and API calls
        (function () {
            const params = new URLSearchParams(window.location.search);

            // parentOrigin MUST be explicitly provided - never allow wildcard for security
            const parentOrigin = params.get('parentOrigin');
            if (!parentOrigin || parentOrigin === '*') {
                console.error('[CommentKit Bridge] Valid parentOrigin parameter is required for security');
                return;
            }

            // API base can be passed as param, or defaults to iframe's own origin
            const apiBase = params.get('apiBase') || window.location.origin;

            // CSRF token must be provided for mutation requests
            const csrfToken = params.get('csrfToken') || '';

            // Signed origin token - proves the actual page origin (anti-spoofing)
            const originToken = params.get('originToken') || '';

            const CONFIG = {
                apiBase: apiBase,
                domain: params.get('domain') || '',
                pageId: params.get('pageId') || '',
                parentOrigin: parentOrigin,
                csrfToken: csrfToken,
                originToken: originToken
            };

            console.log('[CommentKit Bridge] Initialized with:', CONFIG);

            // Session management - now uses HttpOnly cookies (set by server, not accessible to JS)
            // This is more secure than localStorage as tokens can't be stolen via XSS
            let currentUser = null;

            // Check authentication status by calling the server
            // The server will read the HttpOnly cookie automatically
            async function checkAuth() {
                try {
                    const user = await apiCall('/api/v1/auth/me');
                    currentUser = user;
                    return user;
                } catch (e) {
                    // Not authenticated or cookie expired
                    console.log('[CommentKit Bridge] Auth check failed:', e.message);
                    currentUser = null;
                    return null;
                }
            }

            // Send auth state to parent
            function sendAuthState() {
                window.parent.postMessage({
                    type: 'commentkit',
                    action: 'authStateChanged',
                    user: currentUser
                }, CONFIG.parentOrigin);
            }

            // API helper - uses HttpOnly cookies for authentication (more secure than localStorage)
            async function apiCall(path, options = {}) {
                const url = CONFIG.apiBase + path;
                const headers = {
                    'Content-Type': 'application/json',
                    // Always include CSRF token for mutation requests
                    'X-CSRF-Token': CONFIG.csrfToken,
                    // Include signed origin token for anti-spoofing protection
                    // This token is cryptographically signed and proves the actual page origin
                    'X-Origin-Token': CONFIG.originToken
                };

                const response = await fetch(url, {
                    ...options,
                    headers: { ...headers, ...options.headers },
                    // Include credentials (cookies) for cross-origin requests
                    credentials: 'include'
                });

                // Handle non-JSON responses gracefully
                const contentType = response.headers.get('content-type') || '';
                if (!contentType.includes('application/json')) {
                    const text = await response.text();
                    throw new Error(response.ok ? 'Invalid response format' : `Server error: ${response.status}`);
                }

                const data = await response.json();

                // Check for HTTP errors even with JSON response
                if (!response.ok) {
                    throw new Error(data.error || data.message || `Request failed: ${response.status}`);
                }

                return data;
            }

            // Message handler
            window.addEventListener('message', async (event) => {
                if (event.origin !== CONFIG.parentOrigin) {
                    console.log('[CommentKit Bridge] Ignored message from:', event.origin);
                    return;
                }

                const message = event.data;
                if (!message || message.type !== 'commentkit') return;

                console.log('[CommentKit Bridge] Received action:', message.action);

                try {
                    switch (message.action) {
                        case 'loadComments': {
                            const params = new URLSearchParams({
                                domain: message.domain,
                                pageId: message.pageId,
                                title: message.pageTitle || '',
                                url: message.pageUrl || ''
                            });

                            const data = await apiCall(`/api/v1/sites/comments?${params}`);

                            window.parent.postMessage({
                                type: 'commentkit',
                                action: 'commentsLoaded',
                                data: data
                            }, CONFIG.parentOrigin);
                            break;
                        }

                        case 'postComment': {
                            // Validate CSRF token before processing mutation
                            if (!CONFIG.csrfToken || message.csrfToken !== CONFIG.csrfToken) {
                                console.error('[CommentKit Bridge] CSRF token mismatch');
                                window.parent.postMessage({
                                    type: 'commentkit',
                                    action: 'error',
                                    message: 'Security validation failed. Please refresh and try again.'
                                }, CONFIG.parentOrigin);
                                break;
                            }

                            // Build comment payload - authenticated users don't need name/email
                            const commentPayload = {
                                domain: message.domain,
                                pageId: message.pageId,
                                content: message.content,
                                parent_id: message.parent_id || undefined,
                                page_title: message.pageTitle,
                                page_url: message.pageUrl
                            };

                            // Only include guest fields if not authenticated
                            if (!currentUser) {
                                commentPayload.author_name = message.author_name;
                                commentPayload.author_email = message.author_email || undefined;
                            }

                            const data = await apiCall('/api/v1/sites/comments', {
                                method: 'POST',
                                headers: {
                                    'X-CSRF-Token': CONFIG.csrfToken
                                },
                                body: JSON.stringify(commentPayload)
                            });

                            if (data.error) {
                                window.parent.postMessage({
                                    type: 'commentkit',
                                    action: 'error',
                                    message: data.error
                                }, CONFIG.parentOrigin);
                            } else {
                                window.parent.postMessage({
                                    type: 'commentkit',
                                    action: 'commentPosted',
                                    data: data
                                }, CONFIG.parentOrigin);
                            }
                            break;
                        }

                        case 'login': {
                            // Send magic link to email
                            try {
                                await apiCall('/api/v1/auth/login', {
                                    method: 'POST',
                                    body: JSON.stringify({
                                        email: message.email,
                                        redirect_url: message.redirectUrl || null
                                    })
                                });
                                window.parent.postMessage({
                                    type: 'commentkit',
                                    action: 'loginEmailSent',
                                    email: message.email
                                }, CONFIG.parentOrigin);
                            } catch (e) {
                                window.parent.postMessage({
                                    type: 'commentkit',
                                    action: 'error',
                                    message: e.message || 'Failed to send login email'
                                }, CONFIG.parentOrigin);
                            }
                            break;
                        }

                        case 'verifyToken': {
                            // Verify magic link token - server sets HttpOnly cookie automatically
                            try {
                                const result = await apiCall(`/api/v1/auth/verify?token=${encodeURIComponent(message.token)}`);
                                if (result.user) {
                                    currentUser = result.user;
                                    sendAuthState();
                                }
                            } catch (e) {
                                window.parent.postMessage({
                                    type: 'commentkit',
                                    action: 'error',
                                    message: e.message || 'Invalid or expired login link'
                                }, CONFIG.parentOrigin);
                            }
                            break;
                        }

                        case 'logout': {
                            try {
                                // Call logout API - server will clear HttpOnly cookie
                                await apiCall('/api/v1/auth/logout', { method: 'POST' });
                            } catch (e) {
                                // Ignore logout errors
                            }
                            currentUser = null;
                            sendAuthState();
                            break;
                        }

                        case 'togglePageLike': {
                            if (!currentUser) {
                                throw new Error('Authentication required');
                            }

                            const method = message.shouldLike ? 'POST' : 'DELETE';
                            const data = await apiCall(`/api/v1/pages/${message.pageId}/likes`, {
                                method
                            });

                            window.parent.postMessage({
                                type: 'commentkit',
                                messageId: message.messageId,
                                data: data
                            }, CONFIG.parentOrigin);
                            break;
                        }

                        case 'toggleCommentLike': {
                            if (!currentUser) {
                                throw new Error('Authentication required');
                            }

                            const method = message.shouldLike ? 'POST' : 'DELETE';
                            const data = await apiCall(`/api/v1/comments/${message.commentId}/likes`, {
                                method
                            });

                            window.parent.postMessage({
                                type: 'commentkit',
                                messageId: message.messageId,
                                data: data
                            }, CONFIG.parentOrigin);
                            break;
                        }

                        case 'checkAuth': {
                            await checkAuth();
                            sendAuthState();
                            break;
                        }

                        default:
                            console.log('[CommentKit Bridge] Unknown action:', message.action);
                    }
                } catch (error) {
                    console.error('[CommentKit Bridge] Error:', error);
                    window.parent.postMessage({
                        type: 'commentkit',
                        action: 'error',
                        message: error.message || 'An error occurred'
                    }, CONFIG.parentOrigin);
                }
            });

            // Check auth status and notify parent that bridge is ready
            (async () => {
                await checkAuth();
                window.parent.postMessage({
                    type: 'commentkit',
                    action: 'bridgeReady',
                    user: currentUser
                }, CONFIG.parentOrigin);
                console.log('[CommentKit Bridge] Ready and listening, user:', currentUser?.email || 'guest');
            })();
        })();
    </script>
</body>

</html>